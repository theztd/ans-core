---
- name: Set fqdn
  hostname:
    name: "{{ inventory_hostname }}"
  ignore_errors: yes
  register: hostname_change

- name: Re-gather facts because hostname update
  action: setup
  when: hostname_change.changed == "true" and hostname_change.failed == "false"

- name: Configure apt to minimize amount of instaled packages
  copy:
    src: debian-minimal
    dest: /etc/apt/apt.conf.d/00_only_required_packages
    mode: 0644
    owner: root

- name: Update cache
  apt:
    update_cache: yes

- name: Install core tools
  apt:
    state: present
    name: "{{ item }}"
  with_items:
  - vim
  - tree
  - htop
  - git

- name: Debian security patches
  apt:
    name: unattended-upgrades
    state: present

- name: Configure security updates
  template:
    src: "33-security-updates.j2"
    dest: "/etc/apt/apt.conf.d/{{ item }}"
    owner: root
    group: root
    mode: 0644

- name: Disable IPv6
  copy:
    src: noIPv6
    dest: /etc/modprobe.d/noIPv6
    mode: 0640
  when: disable_ipv6 == "true"

- name: Sysctl hardening
  template:
    src: sysctl.conf
    dest: /etc/sysctl.d/hardening.conf
    mode: 0640
  when: hardening_os == "true"

- name: Configure bash
  copy:
    src: 00-custom_bash.sh
    dest: /etc/profile.d/00-custom_bash.sh
    mode: 0755
    owner: root

- name: Clean etc skel
  file:
    path: /etc/skel/.bashrc
    state: absent

- name: Copy vimrc configuration
  copy:
    src: vimrc
    dest: /etc/vim/vimrc
    owner: root

- name: Copy virc configuration
  copy:
    src: vimrc
    dest: /etc/vim/virc
    owner: root

- name: Manage sshd
  include: sshd.yml

- name: OS permissions hardening
  include: perms.yml
  when: hardening_os == "true"

- name: Configure logrotate
  copy:
    src: "{{ item }}"
    dest: "/etc/logrotate.d/{{ item }}"
    owner: root
    mode: 0644
  with_items:
  - rotate_history.conf

- name: Configure rsyslog
  copy:
    src: "{{ item }}"
    dest: "/etc/rsyslog.d/{{ item }}"
    owner: root
    mode: 0644
  with_items:
  - log_history.conf

- name: Reload rsyslog
  systemd:
    service: rsyslog
    state: restarted 
